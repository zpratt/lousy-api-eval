name: API Lint

on:
  pull_request:
    paths:
      - "**/*.openapi.yaml"
      - "**/*.openapi.json"
      - "openapi/**"
      - "specs/**"
      - "openapi.yaml"
      - "openapi.json"
      - ".spectral.yaml"

jobs:
  spectral-lint:
    name: Spectral OpenAPI Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.7

      - name: Setup Node
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8  # v4.0.4
        with:
          node-version-file: .nvmrc

      - name: Install dependencies
        run: npm ci

      - name: Find OpenAPI specs
        id: find-specs
        run: |
          # Adjust the find pattern to match your project structure
          SPECS=$(find . -not -path '*/node_modules/*' -type f \( -name "*.openapi.yaml" -o -name "*.openapi.json" -o -name "openapi.yaml" -o -name "openapi.json" \))
          if [ -z "$SPECS" ]; then
            echo "No OpenAPI spec files found"
            echo "found=false" >> "$GITHUB_OUTPUT"
          else
            echo "Found specs:"
            echo "$SPECS"
            echo "found=true" >> "$GITHUB_OUTPUT"
            # Store newline-delimited list
            EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
            echo "specs<<$EOF" >> "$GITHUB_OUTPUT"
            echo "$SPECS" >> "$GITHUB_OUTPUT"
            echo "$EOF" >> "$GITHUB_OUTPUT"
          fi

      - name: Lint OpenAPI specs
        if: steps.find-specs.outputs.found == 'true'
        run: |
          EXIT_CODE=0
          while IFS= read -r spec; do
            echo "::group::Linting $spec"
            npm run lint:spectral -- "$spec" \
              --format=github-actions || EXIT_CODE=$?
            echo "::endgroup::"
          done <<< "${{ steps.find-specs.outputs.specs }}"
          exit $EXIT_CODE

      - name: Lint summary (JSON artifact)
        if: steps.find-specs.outputs.found == 'true' && always()
        run: |
          mkdir -p lint-results
          while IFS= read -r spec; do
            BASENAME=$(echo "$spec" | sed 's/[\/.]/_/g')
            npm run lint:spectral -- "$spec" \
              --format=json \
              --output="lint-results/${BASENAME}.json" || true
          done <<< "${{ steps.find-specs.outputs.specs }}"

      - name: Upload lint results
        if: steps.find-specs.outputs.found == 'true' && always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: spectral-lint-results
          path: lint-results/
          retention-days: 5
